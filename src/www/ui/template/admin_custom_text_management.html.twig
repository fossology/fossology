{# SPDX-FileCopyrightText: Â© 2025 Harshit Gandhi <gandhiharshit716@gmail.com>

   SPDX-License-Identifier: FSFAP
#}
{% extends "include/base.html.twig" %}

{% block content %}

<div style="margin-bottom: 20px;">
  <h2>{{ 'Text Management'|trans }}</h2>
</div>

<table class="semibordered" id="customPhrasesTable" width="100%" cellpadding="0">
  <thead>
    <tr>
      <th width="5%">{{ "Edit"|trans }}</th>
      <th width="25%">{{ "Licenses"|trans }}</th>
      <th width="15%">{{ "Text"|trans }}</th>
      <th width="15%">{{ "Acknowledgement"|trans }}</th>
      <th width="10%">{{ "Comments"|trans }}</th>
      <th width="10%">{{ "Created By"|trans }}</th>
      <th width="10%">{{ "Created Date"|trans }}</th>
      <th width="5%">{{ "Status"|trans }}</th>
      <th width="5%">{{ "Actions"|trans }}</th>
    </tr>
  </thead>
</table>

<br/><br/>
<div style="text-align:center;">
  <a href="{{ formAction }}&edit=0" class="buttonLink">{{ 'Add New Custom Text'|trans }}</a>
</div>

{% endblock %}

{% block foot %}
  {{ parent() }}
  <script src="scripts/jquery.dataTables.min.js" type="text/javascript"></script>
  <script src="scripts/jquery.dataTables.select.js" type="text/javascript"></script>
  <script type="text/javascript">
    function createBrowseTable() {

    dataTableConfig =
        {
          "processing": true,
          "serverSide": true,
          "paginationType": "listbox",
          "ajax": {
            "url": "?mod=admin_custom_text_management&action=fetchData",
            "type": "GET"
          },
          "columns": [
            { "data": 0, "orderable": false },
            { "data": 1, "orderable": false },
            { "data": 2, "orderable": false },
            { "data": 3, "orderable": false },
            { "data": 4, "orderable": false },
            { "data": 5, "orderable": false },
            { "data": 6, "orderable": true },
            { "data": 7, "orderable": false },
            { "data": 8, "orderable": false }
          ],
          "order": [[ 6, "desc" ]],
          "autoWidth": false,
          "columnDefs": [{
            "createdCell": function (cell) {
              $(cell).attr("style", "text-align:center");
            },
            "searchable": false,
            "targets": [0, 6, 7, 8]
          },{
            "orderable": false,
            "searchable": false,
            "targets": [0, 7, 8]
          },{
            "orderable": false,
            "searchable": true,
            "targets": [1, 2, 3, 4, 5]
          },{
            "orderable": true,
            "searchable": false,
            "targets": [6]
          }],
          "pageLength": 20,
          "stateSave": true,
          "dom": '<"top"lf>rt<"bottom"ip><"clear">',
          "initComplete": function() {
            var buttonsHtml = '<div style="float: right; margin-left: 20px; margin-right: 10px;">' +
              '<a href="?mod=admin_custom_text_to_csv" class="buttonLink">Export CSV</a> ' +
              '<a href="?mod=admin_custom_text_to_json" class="buttonLink">Export JSON</a> ' +
              '<a href="?mod=admin_custom_text_from_csv" class="buttonLink">Import CSV/JSON</a>' +
              '</div>';
            
            // Insert buttons before the search input
            $('.dataTables_filter').before(buttonsHtml);
          }
        };

      var otable = $('#customPhrasesTable').DataTable(dataTableConfig);
      return otable;
    }

    function deletePhrase(phraseId) {
      if (confirm("{{ 'Are you sure you want to delete this custom text? This action cannot be undone.'|trans }}")) {
        $.ajax({
          url: "?mod=admin_custom_text_management&action=delete",
          type: "POST",
          data: { id: phraseId },
          dataType: "json",
          success: function (data) {
            if (data.error) {
              alert("Error: " + data.error);
            } else {
              alert(data.message || "{{ 'Custom text deleted successfully!'|trans }}");
              $('#customPhrasesTable').DataTable().ajax.reload(null, false);
            }
          },
          error: function (xhr, status, error) {
            alert("{{ 'Error deleting text:'|trans }} " + error);
          }
        });
      }
    }

    function togglePhraseStatus(phraseId, currentStatus) {
      $.ajax({
        url: "?mod=admin_custom_text_management&action=toggle",
        type: "POST",
        data: { id: phraseId, status: currentStatus ? 0 : 1 },
        dataType: "json",
        success: function (data) {
          if (data.error) {
            alert("Error: " + data.error);
          } else {
            $('#customPhrasesTable').DataTable().ajax.reload(null, false);
          }
        },
        error: function (xhr, status, error) {
          alert("{{ 'Error toggling status:'|trans }} " + error);
        }
      });
    }
    
    $(document).ready(function () {
      createBrowseTable();
    });
    
  </script>
{% endblock %}
