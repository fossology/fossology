{# SPDX-FileCopyrightText: Â© 2014-2018 Siemens AG

   SPDX-License-Identifier: FSFAP
#}
selectedLicensesTableColumns = [
  {"sTitle": "{{ 'Action'| trans }}<img src='images/info_16.png' data-toggle='tooltip' title='{{ "Current actions are: 1. Cross: remove (or add again) the license from a clearing result. Note that the license finding stays in the table, but it is not considered for a clearing result 2. Star: mark this license as main license as the package. A main license will appear in the listing of the browse view as well in the reporting"|trans }}' alt='' class='info-bullet'/>", "sClass": "center nobreaktext", "bSortable": false, "sWidth" : "1%"},
  {"sTitle": "{{ 'License'| trans }}<img src='images/info_16.png' data-toggle='tooltip' title='{{ "Short ID (or SPDX ID) of the license. Clicking the license short ID will reveal the  license text"|trans }}' alt='' class='info-bullet'/>", "sClass": "left nobreaktext"},
  {"sTitle": "{{ 'Source'| trans }}<img src='images/info_16.png' data-toggle='tooltip' title='{{ "Showing the agent or user action which yielded this finding"|trans }}' alt='' class='info-bullet'/>", "sClass": "left nobreaktext", "bSortable": false},
  {"sTitle": "{{ 'License Text'| trans }}<img src='images/info_16.png' data-toggle='tooltip' title='{{ "The license text will normally appear in the reporting. If the text from the database should be overridden, because the license text is customized, then the custom license text for reporting can be pasted here"|trans }}' alt='' class='info-bullet'/>", "sClass": "left nobreaktext", "bSortable": false},
  {"sTitle": "{{ 'Acknowledgement'| trans }}<img src='images/info_16.png' data-toggle='tooltip' title='{{ "Special acknowledgement text found or determined for a particular license can be placed into the according row of this column"|trans }}' alt='' class='info-bullet'/>", "sClass": "left nobreaktext", "bSortable": false},
  {"sTitle": "{{ 'Comment'| trans }}<img src='images/info_16.png' data-toggle='tooltip' title='{{ "Showing a comment in the reporting for this particular license finding in this file can be shown here. Could be useful for - to be discussed"|trans }}' alt='' class='info-bullet'/>", "sClass": "left nobreaktext", "bSortable": false}
];

uploadId = {{ uploadId }};
itemId = {{ itemId }};
searchMatches = {{ searchMatches|json_encode|raw }};
searchQuery = "{{ searchQuery }}";

selectedLicensesTableConfig = {
  "bServerSide": true,
  "sAjaxSource": "?mod=conclude-license&do=licenseDecisions",
  "fnServerData": function (sSource, aoData, fnCallback) {
    aoData.push({"name": "upload", "value": uploadId});
    aoData.push({"name": "item", "value": itemId});
    $.getJSON(sSource, aoData, fnCallback)
      .fail(failed)
  },
  "fnRowCallback": function( nRow, aData, iDisplayIndex, iDisplayIndexFull ) {
      if (nRow.className.match(/(^| )removed($| )/g)  ) {
          $('td', nRow).addClass('read_only');
      }
  },
  "aoColumns": selectedLicensesTableColumns,
  "iDisplayLength": 25,
  "bProcessing": true,
  "bStateSave": true,
  "bRetrieve": true,
  "bPaginate": false,
  "bFilter": false,
  "bAutoWidth": false
};

editableConfiguration = {
  "sUpdateURL": "?mod=conclude-license&do=updateClearings",
  "fnOnEditing": function(input) {return input[0].value;},
  "fnOnEdited": function (status){ if(status==="success") { $('#decTypeSet').addClass('border-danger');} } ,
  "fnOnDeleted": function(result) { createTable().fnDraw(false);},
  "sSuccessResponse": "success",
  "aoColumns": [null, null, null, null, null, null]
};

function createClearingTable() {
  otable = $('#licenseDecisionsTable').dataTable(selectedLicensesTableConfig).makeEditable(editableConfiguration);
  return otable;
}

addLicenseTableColumns = [
  {"sTitle": "{{ 'License'| trans }}", "sClass": "left"},
  {"sTitle": "{{ 'Action'| trans }}", "sClass": "center", "bSortable": false}
];

addLicenseTableConfig = {
  "bServerSide": true,
  "sAjaxSource": "?mod=conclude-license&do=licenses",
  "fnServerData": function (sSource, aoData, fnCallback) {
    aoData.push({"name": "upload", "value": uploadId});
    aoData.push({"name": "item", "value": itemId});
    $.getJSON(sSource, aoData, function (data) {
      const searchTerm = $('#licenseSelectionTable_filter input').val();
      if (searchTerm) {
        if (searchTerm.startsWith('=')) {
          const exactMatchTerm = searchTerm.substring(1).trim().toLowerCase();

          data.aaData = data.aaData.filter(function (row) {
            const licenseName = $(row[0]).text().toLowerCase();
            return licenseName === exactMatchTerm;
          });
        } else {
          const partialMatchTerm = searchTerm.trim().toLowerCase();

          data.aaData = data.aaData.filter(function (row) {
            const licenseName = $(row[0]).text().toLowerCase();
            return licenseName.includes(partialMatchTerm);
          });
        }
      }
      fnCallback(data);
    }).fail(failed);
  },
  "aoColumns": addLicenseTableColumns,
  "iDisplayLength": 25,
  "bProcessing": true,
  "bStateSave": true,
  "bRetrieve": true,
  "bPaginate": false,
  "bFilter": true,
  "oSearch": true,
};

addClearingHistoryColumns = [
  {"sTitle": "{{ 'Date'| trans }}", "sClass": "left", "bSortable": false},
  {"sTitle": "{{ 'Username'| trans }}", "sClass": "left", "bSortable": false},
  {"sTitle": "{{ 'Scope'| trans }}", "sClass": "left", "bSortable": false},
  {"sTitle": "{{ 'Type'| trans }}", "sClass": "left", "bSortable": false},
  {"sTitle": "{{ 'Licenses'| trans }}", "sClass": "left", "bSortable": false}
];

addClearingHistoryTableConfig = {
  "bServerSide": true,
  "sAjaxSource": "?mod=conclude-license&do=showClearingHistory",
  "fnServerData": function (sSource, aoData, fnCallback) {
    aoData.push({"name": "upload", "value": uploadId});
    aoData.push({"name": "item", "value": itemId});
    $.getJSON(sSource, aoData, fnCallback).fail(failed);
  },
  "aoColumns": addClearingHistoryColumns,
  "iDisplayLength": 25,
  "bProcessing": true,
  "bStateSave": true,
  "bRetrieve": false,
  "bPaginate": false,
  "bFilter": false,
  "bDestroy": true
};


function createLicenseSelectionTable() {
  otable = $('#licenseSelectionTable').dataTable(addLicenseTableConfig);
  return otable;
}

function createClearingHistoryDataTable() {
  otable = $('#ClearingHistoryDataModalTable').dataTable(addClearingHistoryTableConfig);
  return otable;
}

var searchMatches = searchMatches || [];
var currentMatchIndex = -1;
var currentPage = {{ currentPage }};

const getMatchesOnPage = () => searchMatches.reduce((acc, m, i) => (m.page === currentPage ? [...acc, i] : acc), []);

function initSearchNavigation() {
  if (!searchMatches.length) return;
  $("#btnNextMatch, #btnPrevMatch").prop("disabled", false);

  const matchesOnPage = getMatchesOnPage();
  const urlParams = new URLSearchParams(window.location.search);
  const initialMatchIndex = parseInt(urlParams.get('matchIndex'));

  if (matchesOnPage.length > 0) {
    const target = (initialMatchIndex >= 0 && searchMatches[initialMatchIndex]?.page === currentPage) 
                   ? initialMatchIndex : matchesOnPage[0];
    navigateToMatch(target);
  } else {
    $("#searchCountInfo").text(`0 / ${searchMatches.length} (page ${currentPage + 1})`);
  }
}

function navigateToMatch(index) {
  if (!searchMatches.length) return;

  currentMatchIndex = (index + searchMatches.length) % searchMatches.length;
  const match = searchMatches[currentMatchIndex];

  if (match.page !== currentPage) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', match.page);
    url.searchParams.set('search', searchQuery);
    url.searchParams.set('matchIndex', currentMatchIndex);
    window.location.href = url.href;
    return;
  }

  const localIndex = getMatchesOnPage().indexOf(currentMatchIndex);

  if (localIndex >= 0) {
    $(".hi-search-match").removeClass("active-match");
    const currentElements = $(`.hi-search-match[data-match-index='${localIndex}']`);

    if (currentElements.length) {
      currentElements.addClass("active-match");
      const container = $("#fileTextView");
      const scrollTop = currentElements.first().offset().top - container.offset().top + container.scrollTop() - (container.height() / 2);
      container.animate({scrollTop}, 300);
    }
    $("#searchCountInfo").text(`${currentMatchIndex + 1} / ${searchMatches.length}`);
  }
}

function performSearch() {
  const term = $("#textSearchInput").val().trim();
  if (term.length > 0 && term.length < 3) {
    alert("Search term too short (min 3 chars)");
    return;
  }
  if (term.length === 0) {
    clearSearch();
    return;
  }

  const url = new URL(window.location.href);
  url.searchParams.set('search', term);
  url.searchParams.set('page', '0');
  url.searchParams.delete('matchIndex');
  window.location.href = url.href;
}

function clearSearch() {
  const url = new URL(window.location.href);
  url.searchParams.delete('search');
  url.searchParams.delete('matchIndex');
  url.searchParams.set('page', '0');
  window.location.href = url.href;
}

function highlightSearchMatches() {
  const container = document.getElementById("fileTextView");
  const searchText = "{{ searchQuery|e('js') }}";
  if (!container || !searchText) return;

  let allText = "";
  const nodeMap = []; 
  const treeWalker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, null, false);

  while (treeWalker.nextNode()) {
    const node = treeWalker.currentNode;
    if (node.parentNode.classList.contains("hi-search-match")) continue;

    [...node.nodeValue].forEach((char, i) => {
      nodeMap.push({ node, index: i });
      allText += char;
    });
  }

  const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), "gi");
  let match;
  const matches = [];
  while ((match = regex.exec(allText)) !== null) {
    matches.push({ start: match.index, end: match.index + searchText.length });
  }

  matches.reverse().forEach((m, matchIdx) => {
    const rangesToWrap = [];
    let currentRange = null;

    for (let i = m.start; i < m.end; i++) {
      const map = nodeMap[i];
      if (!currentRange || map.node !== currentRange.node) {
        if (currentRange) rangesToWrap.push(currentRange);
        currentRange = { node: map.node, start: map.index, end: map.index + 1 };
      } else {
        currentRange.end = map.index + 1;
      }
    }
    if (currentRange) rangesToWrap.push(currentRange);

    rangesToWrap.forEach(r => {
      const range = document.createRange();
      range.setStart(r.node, r.start);
      range.setEnd(r.node, r.end);
      const span = document.createElement('span');
      span.className = "hi-search-match";
      span.setAttribute("data-match-index", matches.length - 1 - matchIdx); 
      range.surroundContents(span);
    });
  });
}

$(document).ready(function () {
  createClearingTable();
  createLicenseSelectionTable();
  $('[data-toggle="tooltip"]').tooltip();

  {% if searchQuery %}
    highlightSearchMatches(); 
  {% endif %}
  initSearchNavigation();

  $("#btnTriggerSearch").click(performSearch);
  $("#textSearchInput").keypress(function(e) {
    if(e.which == 13) { performSearch(); }
  });
  
  $("#btnClearSearch").click(clearSearch);

  $("#btnNextMatch").click(function() {
    navigateToMatch(currentMatchIndex + 1);
  });

  $("#btnPrevMatch").click(function() {
    navigateToMatch(currentMatchIndex - 1);
  });
});
